=== modified file 'pidgin-2.4.3/libpurple/protocols/qq/ChangeLog'
--- pidgin-2.4.3/libpurple/protocols/qq/ChangeLog	2008-07-15 04:57:45 +0000
+++ pidgin-2.4.3.1/libpurple/protocols/qq/ChangeLog	2008-07-15 04:58:02 +0000
@@ -1,3 +1,8 @@
+2008.07.12 - ccpaging <ecc_hy(at)hotmail.com>
+	* Fixed: Always lost connection. Now send keep alive packet in every 30 seconds
+	* Minor fix for debug information
+	* Filter \r\n and replace with SPCAE in group notive
+
 2008.06.29 - csyfek <csyfek(at)gmail.com>
 	* Minor bug fix
 	* Add some doxygen syntax for preparing development documentation

=== modified file 'pidgin-2.4.3/libpurple/protocols/qq/Makefile.in'
--- pidgin-2.4.3/libpurple/protocols/qq/Makefile.in	2008-07-15 04:57:45 +0000
+++ pidgin-2.4.3.1/libpurple/protocols/qq/Makefile.in	2008-07-15 04:58:02 +0000
@@ -1,8 +1,8 @@
-# Makefile.in generated by automake 1.10.1 from Makefile.am.
+# Makefile.in generated by automake 1.10 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008  Free Software Foundation, Inc.
+# 2003, 2004, 2005, 2006  Free Software Foundation, Inc.
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -35,8 +35,7 @@
 host_triplet = @host@
 target_triplet = @target@
 subdir = libpurple/protocols/qq
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in AUTHORS \
-	ChangeLog
+DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in AUTHORS
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
 am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
 	$(top_srcdir)/configure.ac
@@ -59,9 +58,10 @@
 	group_network.c group_network.h group_opt.c group_opt.h \
 	group_search.c group_search.h header_info.c header_info.h im.c \
 	im.h keep_alive.c keep_alive.h login_logout.c login_logout.h \
-	packet_parse.c packet_parse.h qq.c qq.h qq_network.c \
-	qq_network.h send_file.c send_file.h qq_trans.c qq_trans.h \
-	sys_msg.c sys_msg.h utils.c utils.h
+	packet_parse.c packet_parse.h qq.c qq.h qq_network.c qq_network.h \
+	send_file.c \
+	send_file.h qq_trans.c qq_trans.h sys_msg.c sys_msg.h \
+	utils.c utils.h
 am__objects_1 = libqq_a-buddy_info.$(OBJEXT) \
 	libqq_a-buddy_list.$(OBJEXT) libqq_a-buddy_opt.$(OBJEXT) \
 	libqq_a-buddy_status.$(OBJEXT) libqq_a-char_conv.$(OBJEXT) \
@@ -76,7 +76,8 @@
 	libqq_a-login_logout.$(OBJEXT) libqq_a-packet_parse.$(OBJEXT) \
 	libqq_a-qq.$(OBJEXT) libqq_a-qq_network.$(OBJEXT) \
 	libqq_a-send_file.$(OBJEXT) libqq_a-qq_trans.$(OBJEXT) \
-	libqq_a-sys_msg.$(OBJEXT) libqq_a-utils.$(OBJEXT)
+	libqq_a-sys_msg.$(OBJEXT) \
+	libqq_a-utils.$(OBJEXT)
 @STATIC_QQ_TRUE@am_libqq_a_OBJECTS = $(am__objects_1)
 libqq_a_OBJECTS = $(am_libqq_a_OBJECTS)
 am__vpath_adj_setup = srcdirstrip=`echo "$(srcdir)" | sed 's|.|.|g'`;
@@ -100,23 +101,25 @@
 	group_network.c group_network.h group_opt.c group_opt.h \
 	group_search.c group_search.h header_info.c header_info.h im.c \
 	im.h keep_alive.c keep_alive.h login_logout.c login_logout.h \
-	packet_parse.c packet_parse.h qq.c qq.h qq_network.c \
-	qq_network.h send_file.c send_file.h qq_trans.c qq_trans.h \
-	sys_msg.c sys_msg.h utils.c utils.h
+	packet_parse.c packet_parse.h qq.c qq.h qq_network.c qq_network.h \
+	send_file.c \
+	send_file.h qq_trans.c qq_trans.h sys_msg.c sys_msg.h \
+	utils.c utils.h
 am__objects_2 = buddy_info.lo buddy_list.lo buddy_opt.lo \
 	buddy_status.lo char_conv.lo crypt.lo file_trans.lo group.lo \
 	group_conv.lo group_find.lo group_free.lo group_internal.lo \
 	group_im.lo group_info.lo group_join.lo group_network.lo \
 	group_opt.lo group_search.lo header_info.lo im.lo \
 	keep_alive.lo login_logout.lo packet_parse.lo qq.lo \
-	qq_network.lo send_file.lo qq_trans.lo sys_msg.lo utils.lo
+	qq_network.lo send_file.lo \
+	qq_trans.lo sys_msg.lo utils.lo
 @STATIC_QQ_FALSE@am_libqq_la_OBJECTS = $(am__objects_2)
 libqq_la_OBJECTS = $(am_libqq_la_OBJECTS)
 libqq_la_LINK = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
 	--mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(libqq_la_LDFLAGS) \
 	$(LDFLAGS) -o $@
 @STATIC_QQ_FALSE@am_libqq_la_rpath = -rpath $(pkgdir)
-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
+DEFAULT_INCLUDES = -I. -I$(top_builddir)@am__isrc@
 depcomp = $(SHELL) $(top_srcdir)/depcomp
 am__depfiles_maybe = depfiles
 COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
@@ -216,12 +219,14 @@
 INTLTOOL_DESKTOP_RULE = @INTLTOOL_DESKTOP_RULE@
 INTLTOOL_DIRECTORY_RULE = @INTLTOOL_DIRECTORY_RULE@
 INTLTOOL_EXTRACT = @INTLTOOL_EXTRACT@
+INTLTOOL_ICONV = @INTLTOOL_ICONV@
 INTLTOOL_KBD_RULE = @INTLTOOL_KBD_RULE@
 INTLTOOL_KEYS_RULE = @INTLTOOL_KEYS_RULE@
 INTLTOOL_MERGE = @INTLTOOL_MERGE@
+INTLTOOL_MSGFMT = @INTLTOOL_MSGFMT@
+INTLTOOL_MSGMERGE = @INTLTOOL_MSGMERGE@
 INTLTOOL_OAF_RULE = @INTLTOOL_OAF_RULE@
 INTLTOOL_PERL = @INTLTOOL_PERL@
-INTLTOOL_POLICY_RULE = @INTLTOOL_POLICY_RULE@
 INTLTOOL_PONG_RULE = @INTLTOOL_PONG_RULE@
 INTLTOOL_PROP_RULE = @INTLTOOL_PROP_RULE@
 INTLTOOL_SCHEMAS_RULE = @INTLTOOL_SCHEMAS_RULE@
@@ -233,6 +238,7 @@
 INTLTOOL_UI_RULE = @INTLTOOL_UI_RULE@
 INTLTOOL_UPDATE = @INTLTOOL_UPDATE@
 INTLTOOL_XAM_RULE = @INTLTOOL_XAM_RULE@
+INTLTOOL_XGETTEXT = @INTLTOOL_XGETTEXT@
 INTLTOOL_XML_NOMERGE_RULE = @INTLTOOL_XML_NOMERGE_RULE@
 INTLTOOL_XML_RULE = @INTLTOOL_XML_RULE@
 KRB4_CFLAGS = @KRB4_CFLAGS@
@@ -240,6 +246,8 @@
 KRB4_LIBS = @KRB4_LIBS@
 LDADD = @LDADD@
 LDFLAGS = @LDFLAGS@
+LIBNM_CFLAGS = @LIBNM_CFLAGS@
+LIBNM_LIBS = @LIBNM_LIBS@
 LIBOBJS = @LIBOBJS@
 LIBPERL_A = @LIBPERL_A@
 LIBS = @LIBS@
@@ -257,9 +265,6 @@
 MONO_LIBS = @MONO_LIBS@
 MSGFMT = @MSGFMT@
 MSGFMT_OPTS = @MSGFMT_OPTS@
-MSGMERGE = @MSGMERGE@
-NETWORKMANAGER_CFLAGS = @NETWORKMANAGER_CFLAGS@
-NETWORKMANAGER_LIBS = @NETWORKMANAGER_LIBS@
 NSS_CFLAGS = @NSS_CFLAGS@
 NSS_LIBS = @NSS_LIBS@
 OBJEXT = @OBJEXT@
@@ -513,8 +518,8 @@
 	@list='$(pkg_LTLIBRARIES)'; for p in $$list; do \
 	  if test -f $$p; then \
 	    f=$(am__strip_dir) \
-	    echo " $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(pkgLTLIBRARIES_INSTALL) $(INSTALL_STRIP_FLAG) '$$p' '$(DESTDIR)$(pkgdir)/$$f'"; \
-	    $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(pkgLTLIBRARIES_INSTALL) $(INSTALL_STRIP_FLAG) "$$p" "$(DESTDIR)$(pkgdir)/$$f"; \
+	    echo " $(LIBTOOL) --mode=install $(pkgLTLIBRARIES_INSTALL) $(INSTALL_STRIP_FLAG) '$$p' '$(DESTDIR)$(pkgdir)/$$f'"; \
+	    $(LIBTOOL) --mode=install $(pkgLTLIBRARIES_INSTALL) $(INSTALL_STRIP_FLAG) "$$p" "$(DESTDIR)$(pkgdir)/$$f"; \
 	  else :; fi; \
 	done
 
@@ -522,8 +527,8 @@
 	@$(NORMAL_UNINSTALL)
 	@list='$(pkg_LTLIBRARIES)'; for p in $$list; do \
 	  p=$(am__strip_dir) \
-	  echo " $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=uninstall rm -f '$(DESTDIR)$(pkgdir)/$$p'"; \
-	  $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=uninstall rm -f "$(DESTDIR)$(pkgdir)/$$p"; \
+	  echo " $(LIBTOOL) --mode=uninstall rm -f '$(DESTDIR)$(pkgdir)/$$p'"; \
+	  $(LIBTOOL) --mode=uninstall rm -f "$(DESTDIR)$(pkgdir)/$$p"; \
 	done
 
 clean-pkgLTLIBRARIES:
@@ -589,16 +594,16 @@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libqq_a-packet_parse.Po@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libqq_a-qq.Po@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libqq_a-qq_network.Po@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libqq_a-send_file.Po@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libqq_a-qq_trans.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libqq_a-send_file.Po@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libqq_a-sys_msg.Po@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libqq_a-utils.Po@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/login_logout.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/packet_parse.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/qq.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/qq_network.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/send_file.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/qq_trans.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/send_file.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/sys_msg.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/utils.Plo@am__quote@
 
@@ -1040,8 +1045,8 @@
 	unique=`for i in $$list; do \
 	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
 	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonemtpy = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	  $(AWK) '    { files[$$0] = 1; } \
+	       END { for (i in files) print i; }'`; \
 	mkid -fID $$unique
 tags: TAGS
 
@@ -1053,8 +1058,8 @@
 	unique=`for i in $$list; do \
 	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
 	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	  $(AWK) '    { files[$$0] = 1; } \
+	       END { for (i in files) print i; }'`; \
 	if test -z "$(ETAGS_ARGS)$$tags$$unique"; then :; else \
 	  test -n "$$unique" || unique=$$empty_fix; \
 	  $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
@@ -1064,12 +1069,13 @@
 CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
 		$(TAGS_FILES) $(LISP)
 	tags=; \
+	here=`pwd`; \
 	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
 	unique=`for i in $$list; do \
 	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
 	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	  $(AWK) '    { files[$$0] = 1; } \
+	       END { for (i in files) print i; }'`; \
 	test -z "$(CTAGS_ARGS)$$tags$$unique" \
 	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
 	     $$tags $$unique

=== modified file 'pidgin-2.4.3/libpurple/protocols/qq/buddy_info.c'
--- pidgin-2.4.3/libpurple/protocols/qq/buddy_info.c	2008-07-15 04:57:45 +0000
+++ pidgin-2.4.3.1/libpurple/protocols/qq/buddy_info.c	2008-07-15 04:58:02 +0000
@@ -1009,7 +1009,7 @@
 		bytes += qq_get16(&level, decr_buf + bytes);
 		bytes += qq_get16(&timeRemainder, decr_buf + bytes);
 		purple_debug(PURPLE_DEBUG_INFO, "QQ", 
-				"Level packet entry:\nuid: %d\nonlineTime: %d\nlevel: %d\ntimeRemainder: %d\n", 
+				"Level uid: %d, onlineTime: %d, level: %d, timeRemainder: %d\n", 
 				uid, onlineTime, level, timeRemainder);
 		purple_name = uid_to_purple_name(uid);
 		b = purple_find_buddy(account, purple_name);

=== modified file 'pidgin-2.4.3/libpurple/protocols/qq/char_conv.c'
--- pidgin-2.4.3/libpurple/protocols/qq/char_conv.c	2008-07-15 04:57:45 +0000
+++ pidgin-2.4.3.1/libpurple/protocols/qq/char_conv.c	2008-07-15 04:58:02 +0000
@@ -108,6 +108,12 @@
 
 	ret = g_convert(str, len, to_charset, from_charset, &byte_read, &byte_write, &error);
 
+	/*
+	 qq_hex_dump(PURPLE_DEBUG_WARNING, "QQ",
+		(guint8 *) str, (len == -1) ? strlen(str) : len,
+		"g_convert");
+	*/
+	
 	if (error == NULL) {
 		return ret;	/* conversion is OK */
 	}

=== modified file 'pidgin-2.4.3/libpurple/protocols/qq/group_free.c'
--- pidgin-2.4.3/libpurple/protocols/qq/group_free.c	2008-07-15 04:57:45 +0000
+++ pidgin-2.4.3.1/libpurple/protocols/qq/group_free.c	2008-07-15 04:58:02 +0000
@@ -55,8 +55,10 @@
 {
 	g_return_if_fail(group != NULL);
 	qq_group_free_member(group);
+	g_free(group->my_status_desc);
 	g_free(group->group_name_utf8);
 	g_free(group->group_desc_utf8);
+	g_free(group->notice_utf8);
 	g_free(group);
 }
 

=== modified file 'pidgin-2.4.3/libpurple/protocols/qq/group_info.c'
--- pidgin-2.4.3/libpurple/protocols/qq/group_info.c	2008-07-15 04:57:45 +0000
+++ pidgin-2.4.3.1/libpurple/protocols/qq/group_info.c	2008-07-15 04:58:02 +0000
@@ -157,6 +157,8 @@
 	guint32 unknown4;
 	guint8 unknown1;
 	gint bytes, num;
+	gchar **notice_list;
+	gchar *notice_noreturn;
 
 	g_return_if_fail(data != NULL && len > 0);
 	qd = (qq_data *) gc->proto_data;
@@ -186,15 +188,13 @@
 	bytes += qq_get32(&(group->group_category), data + bytes);
 	bytes += qq_get16(&max_members, data + bytes);
 	bytes += qq_get8(&unknown1, data + bytes);
-	/* XXX
-	 * the following, while Eva:
+	/* the following, while Eva:
 	 * 4(unk), 4(verID), 1(nameLen), nameLen(qunNameContent), 1(0x00),
 	 * 2(qunNoticeLen), qunNoticeLen(qunNoticeContent, 1(qunDescLen),
 	 * qunDestLen(qunDestcontent)) */
 	bytes += qq_get8(&unknown1, data + bytes);
-	purple_debug(PURPLE_DEBUG_INFO, "QQ", "type=%u creatorid=%u category=%u\n",
-			group->group_type, group->creator_uid, group->group_category);
-	purple_debug(PURPLE_DEBUG_INFO, "QQ", "maxmembers=%u", max_members); 
+	purple_debug(PURPLE_DEBUG_INFO, "QQ", "type=%u creatorid=%u category=%u maxmembers=%u\n",
+			group->group_type, group->creator_uid, group->group_category, max_members);
 	
 	/* strlen + <str content> */
 	bytes += convert_as_pascal_string(data + bytes, &(group->group_name_utf8), QQ_CHARSET_DEFAULT);
@@ -236,10 +236,17 @@
 	if(NULL == purple_conv) {
 		purple_debug(PURPLE_DEBUG_WARNING, "QQ",
 				"Conv windows for \"%s\" is not on, do not set topic\n", group->group_name_utf8);
-	}
-	else {
-		purple_conv_chat_set_topic(PURPLE_CONV_CHAT(purple_conv), NULL, group->notice_utf8);
-	}
+		return;
+	}
+
+	/* filter \r\n in notice */
+	notice_list = g_strsplit(group->notice_utf8, "\r\n", -1);
+	notice_noreturn = g_strjoinv(" ", notice_list);
+
+	purple_conv_chat_set_topic(PURPLE_CONV_CHAT(purple_conv), NULL, notice_noreturn);
+
+	g_free(notice_noreturn);
+	g_strfreev(notice_list);
 }
 
 void qq_process_group_cmd_get_online_members(guint8 *data, gint len, PurpleConnection *gc)

=== modified file 'pidgin-2.4.3/libpurple/protocols/qq/qq_network.c'
--- pidgin-2.4.3/libpurple/protocols/qq/qq_network.c	2008-07-15 04:57:45 +0000
+++ pidgin-2.4.3.1/libpurple/protocols/qq/qq_network.c	2008-07-15 04:58:02 +0000
@@ -460,7 +460,10 @@
 		return;
 	}
 
-	gc->last_received = time(NULL);
+	/* keep alive will be sent in 30 seconds since last_receive
+	 *  QQ need a keep alive packet in every 60 seconds
+	 gc->last_received = time(NULL);
+	*/
 	purple_debug(PURPLE_DEBUG_INFO, "TCP_PENDING",
 			   "Read %d bytes from socket, rxlen is %d\n", buf_len, qd->tcp_rxlen);
 	qd->tcp_rxqueue = g_realloc(qd->tcp_rxqueue, buf_len + qd->tcp_rxlen);
@@ -565,7 +568,10 @@
 		return;
 	}
 
-	gc->last_received = time(NULL);
+	/* keep alive will be sent in 30 seconds since last_receive
+	 *  QQ need a keep alive packet in every 60 seconds
+	 gc->last_received = time(NULL);
+	*/
 
 	if (buf_len < QQ_UDP_HEADER_LENGTH) {
 		if (buf[0] != QQ_PACKET_TAG || buf[buf_len - 1] != QQ_PACKET_TAIL) {

